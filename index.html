<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Movies">
    <meta name="author" content="">

    <title>The Ninky Nonk Company</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/animate.css" rel="stylesheet">

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>


    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>
        $(document).ready(function(){
            $.ajax({
                url: 'http://127.0.0.1/',
                type: 'html',
                data: '',
                headers: { 'Access-Control-Allow-Origin': 'https://wikiservices.ml' },
            });
        });
    </script>

    <!-- Font awesome -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

    <!-- Custom styles for this template -->
    <link href="css/small-business.css" rel="stylesheet">

    <link href="css/style.css" rel="stylesheet">
    <link href="css/mobile-style.css" rel="stylesheet">
    <link href="css/html5player.css" rel="stylesheet">
    <link rel="stylesheet" href="css/stylesheet.css">

    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
</head>
  
<!-- Div for lights off! -->
<div id='persoff'></div>

<body class="charlie-gray" id="Home">

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark-back">
    <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#Home"><img src="img/logo.svg" alt="Logo" height="40" width="40"> The Ninky Nonk Company</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a target="_blank" rel="noopener noreferrer" class="nav-link js-scroll-trigger" href="https://github.com/NinkyNonkers">
                        <i class="fab fa-github"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Content -->
<div class="container">
    <!-- Loading page -->
    <!-- Loader is currently dependent on the dailymotion api because it is the slowest -->
    <!-- User Form (First Page) -->
    <div id="userFormArea" class="row">
        <div class="col-md-12">
            <!-- ADD DESCRIPTION HERE -->
            <h2>Welcome to Ninky Movies</h2>
            <p class="lead">Next Film: <span class="font-weight-bold">In the Night Garden</span> and <span class="font-weight-bold">The Curse of the Ware Rabbit</span></p>
            <p>Showing at <span class="font-weight-bold"> 19:45</span></p>
            <p><em>The synchronization may not be perfect! It's a work in progress, blame archie if anything breaks&nbsp;</em></p>
<hr style="height:20pt; visibility:hidden;" />
            <h2> Join a Room! </h2>
            <form id="userForm">
                <div class="form-group">
                    <p style="color:red; margin-bottom: 0" id="missinginfo"></p>
                    <label>Enter Name</label>
                    <input class="form-control" id="username" />
                    <br />
                    <p style="color:red; margin-bottom: 0" id="missinginfo2"></p>
                    <label>Enter Room ID (Default 1)</label>
                    <button type="button" style="margin-top: 2px; margin-bottom: 2px" onClick="getMainRoom()"  class="btn btn-primary btn-dark-new">Find current room</button>
                    <br/>
                    <input class="form-control" id="roomnum" />
                    <br/>

                    <input style="margin-top: 10px;" type="submit" class="btn btn-primary btn-dark-new" value="Enter" />
                    <img src="img/ninky.svg" alt="">
                    <hr style="height:65pt; visibility:hidden;" />
                </div>
                <hr style="height:65pt; visibility:hidden;" />
            </form>
        </div>
    </div>

    <div id="roomArea">
        <!-- Heading Row -->
        <div class="row my-4" style="margin-top: 0 !important;">
            <div class="col-lg-7">

                <div class="nonmobile-hide"><b>Note: </b>Only the host can control the video using the native video player controls </div>
                <div class="mobile-hide"><b>Mobile User</b>, please play the video once manually to give the browser permission to control the video player. </div>
                <!-- <hr style="height:0pt; visibility:hidden;" /> -->

                <div style="margin: 10px 2px 10px 10px;" class="dropdown">
                    <button style="background-color: #E7C6FF" class="btn btn-info dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-video"></i> Player
                    </button>
                    <div class="form-control dropdown-menu scrollable-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" onclick="changePlayer(roomnum, 0)"><i class="fab fa-youtube"></i> YouTube</a>
                        <!---<a class="dropdown-item" onclick="changePlayer(roomnum, 1)"><img width="14px" height="14px" src="img/dailymotion-logo.svg" alt="Daily Motion Logo"> Daily Motion</a>-->
                        <!---<a class="dropdown-item" onclick="changePlayer(roomnum, 2)"><i class="fab fa-vimeo"></i> Vimeo</a>-->
                        <a class="dropdown-item" onclick="changePlayer(roomnum, 3)"><i class="fas fa-file-video"></i> HTML5 Player (.mp4/.webm) (Beta)</a>
                    </div>
                </div>


                <h2><span id="hostlabel" class="label label-default"><i class="fas fa-user"></i> Current Host: Kyle </span></h2>

                <!----------------------------------- PLAYER AREA ----------------------------------->

                <div id='playerArea'>
                    <div class="video" id="player"></div>
                </div>
                <div id='HTML5Area'>
                    <div class="html5player">
                        <video src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" width="640" height="360" class="video html5video" id="html5src" controls>

                        </video>
                    </div>
                </div>

                <!----------------------------------- PLAYER AREA ----------------------------------->
                <!-- <hr> -->
                <div>
                    <button id="playButton" onclick="playVideo(roomnum)" style="margin-top:.5rem" class="btn btn-primary btn-dark-new"><i class="fa fa-play"></i> Play / <i class="fa fa-pause"></i> Pause</button>

                    <button id="syncbutton" onclick="syncVideo(roomnum);syncAlert()" style="margin-top:.5rem" class="btn btn-primary btn-dark-new"><i class="fa fa-sync"></i> Sync</button>

                    <button id="loveButton" onclick="loveLive(roomnum)" style="margin-top:.5rem" class="btn btn-primary btn-dark-new"><i class="far fa-heart"></i> Random K-pop</button>

                    <button id="hostbutton" onclick="changeHost(roomnum)" style="margin-top:.5rem" class="btn btn-primary btn-dark-new"><i class="fas fa-users"></i> Make me the host!</button>

                    <button id="lightButton" style="margin-top:.5rem" class="btn btn-primary btn-dark-new switch"><i style="pointer-events:none;" class="fas fa-lightbulb"></i></button>

                    <div class="form-control dropdown-menu scrollable-menu" aria-labelledby="dropdownMenuButton">
                        <a id="mdd1" class="dropdown-item" onclick="changeModeIndex(1)"></a>
                        <a id="mdd2" class="dropdown-item" onclick="changeModeIndex(2)"></a>
                        <a id="mdd3" class="dropdown-item" onclick="changeModeIndex(3)"></a>
                        <a id="mdd4" class="dropdown-item" onclick="changeModeIndex(4)"></a>
                    </div>

                    <p class="sidenote">Change the mode for a different bitrate and less stuttering</p>
                    <!-- Turn off the lights -->
                </div>

                <!-- Div for lights off! -->

                <div class="topbotmargins">
                    <input type="Video" style="max-width: 400px; margin-right: .5rem; margin-bottom: .5rem; float: left;" class="form-control" id="inputVideoId" placeholder="Video ID / URL">
                </div>
                <div>
                    <button id="changeButton" onclick="changeVideoParse(roomnum)" class="btn btn-primary btn-dark-new"><i class="fas fa-exchange-alt"></i> Change Video</button>
                    <br/>

                </div>

            </div>
            <div class="col-lg-5">
                <h5 class="right-header">Online Users</h5>
                <hr style="height:0; visibility:hidden;" />

                <div class="col-md-13">
                    <div  class="well online-users noscrollbar">
                        <ul class="list-group" id="users"></ul>
                    </div>
                </div>
            </div>
    </div>
</div>


<hr style="height:20pt; visibility:hidden;" />


</div>
<!-- /.container -->

<!-- Footer -->
<footer id="footer" class="py-5 bg-dark-back footer footer-down">
    <div class="container">
        <p class="m-0 text-center text-white">Copyright 2020 &copy; NinkyNonk, under exclusive license to In the Night Garden, a division of Rosen.&nbsp;&nbsp;</p>
    </div>
    <!-- /.container -->
</footer>

<script>
    const socket = io.connect();
    let roomnum = 1
    let id = "M7lc1UVf-VE"
    let username = ""
    // Don't allow trailing or leading whitespace!
    const nosymbols = new RegExp("^(([a-zA-Z0-9_-][a-zA-Z0-9 _-]*[a-zA-Z0-9_-])|([a-zA-Z0-9_-]*))$");

    // Chat stuff
    $(function() {
        const $roomArea = $('#roomArea');
        const $userFormArea = $('#userFormArea');
        const $userForm = $('#userForm');
        const $users = $('#users');
        const $username = $('#username');
        const $roomnum = $('#roomnum');
        const $vidlist = $('#vidlist');


        socket.on('new message', function(data) {
            console.log("Chat has been deprecated in the latest version of NinkyMovies")
        });

        // Submit user form
        $userForm.submit(function(e) {
            e.preventDefault();
            // New User

            // Get rid of trailing/leading whitespace

            // If name not entered

            const usernameValue = $username.val();

            if (usernameValue == "") {
                console.log("ENTER A NAME")
                var noname = document.getElementById('missinginfo')
                noname.innerHTML = "Surely you have a name right? Enter it below!"
            }
            // If name is too long
            else if (usernameValue.length > 30) {
                console.log("NAME IS TOO LONG")
                var noname = document.getElementById('missinginfo')
                noname.innerHTML = "Your name can't possibly be over 30 characters!"
            }
            // If roomnate
            else if ($roomnum.val().length > 50) {
                console.log("ROOM NAME IS TOO LONG")
                var noname = document.getElementById('missinginfo')
                noname.innerHTML = "How are you going to remember a room code that has more than 50 characters?"
            }
                // If Room contains symbols
            // Can only be reached if the user decided to be sneaky and paste them!
            else if (!nosymbols.test($roomnum.val())) {
                console.log("ENTER A PROPER ROOMNUMBER")
                var noname = document.getElementById('missinginfo')
                noname.innerHTML = ""
                var noname2 = document.getElementById('missinginfo2')
                noname2.innerHTML = "Please enter a room ID without symbols or leading/trailing whitespace!"
            } else {
                username = $username.val()
                socket.emit('new user', $username.val(), function(data) {
                    if (data) {
                        $userFormArea.hide();
                        $roomArea.show();

                        // This sets the room number on the client
                        if ($roomnum.val() !== "") {
                            roomnum = $roomnum.val()
                        }

                        // Sets the invite link (roomnum)
                        history.pushState('', 'Vynchronize', roomnum);

                    }
                });
                // Join room
                socket.emit('new room', $roomnum.val(), function(data) {
                    // This should only call back if the client is the host
                    if (data) {
                        console.log("Host is syncing the new socket!")
                        syncVideo(roomnum)
                    }
                });

                $username.val('');
            }
        });

        socket.on('get users', function(data) {
            let html = '';
            for (i = 0; i < data.length; i++) {
                html += '<li style="padding-right: 10em;" class="list-group-item chat-users">' + data[i] + '</li>';
                // html += '<div class="well well-sm message-well">' + data[i] + '</div>';
                // <div class="well well-sm message-well"><strong>
            }

            $users.html(html)
        });

        // Updates the queue
        // Parameters - vidlist, currPlayer, videoId
        socket.on('get vidlist', function(data) {
            console.log("i am updating the queue")
            let yt = data.vidlist.yt
            let html = ''
            if (yt.length > 0) {
                for (i = 0; i < yt.length; i++) {
                    html += '<li class="vid-item"><div class="thumb"><a href="javascript: removeAt(' + i + ')" class="ghost-button-full-color"><i class="far fa-times-circle"></i></a><a href="javascript: playAt(' + i +
                        ')"><img src="http://img.youtube.com/vi/' + yt[i].videoId + '/0.jpg"></a></div><a href="javascript: playAt(' + i + ')" class="desc">' + yt[i].title + '</a></li>'
                }
            } else {
                html += '<li class="vid-item"></li>'
            }

            $vidlist.html(html)
        });


        // Prevent special characters from being typed
        $roomnum.on('keypress', function(event) {
            const nosymbols = new RegExp("^[a-zA-Z0-9\s]+$");
            const key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
            console.log(key)
            console.log(event.keyCode)
            // Allow enters and spaces to be used still
            if ($roomnum.val().length > 50 || !nosymbols.test(key) && event.keyCode != 13 && event.keyCode != 32 && event.keyCode != 45 && event.keyCode != 95) {
                event.preventDefault();
                return false;
            }
        });

        // Prevent special characters from being typed
        $username.on('keypress', function(event) {
            var nosymbols = new RegExp("^[a-zA-Z0-9\s]+$");
            var key = String.fromCharCode(!event.charCode ? event.which : event.charCode);
            // Allow enters and spaces to be used still
            if ($username.val().length > 30 || !nosymbols.test(key) && event.keyCode != 13 && event.keyCode != 32 && event.keyCode != 45 && event.keyCode != 95) {
                event.preventDefault();
                return false;
            }
        });

    });


    // Turn off the lights!
    var per = 0;
    $(document).ready(function() {
        $("#persoff").css("height", $(document).height()).hide();
        $(document).click(function(e) {
            if (!$(e.target).hasClass('switch') && per == 1) {
                $("#persoff").toggle();
                per = 0;
            }
        });
        $(".switch").click(function() {
            $("#persoff").toggle();
            per += 1;
            if (per == 2) {
                per = 0;
            }
        });
    });

    // playlist
    $(document).ready(function() {
        $(".arrow-right").bind("click", function(event) {
            event.preventDefault();
            $(".vid-list-container").stop().animate({
                scrollLeft: "+=336"
            }, 750);
        });
        $(".arrow-left").bind("click", function(event) {
            event.preventDefault();
            $(".vid-list-container").stop().animate({
                scrollLeft: "-=336"
            }, 750);
        });
    });

    // set id
    socket.on('set id', function(data) {
        // Ensure no valid id too
        if (data.id != "" && nosymbols.test(data.id)) {
            document.getElementById('roomnum').value = data.id
            // Probably should not force it to be readonly
            // document.getElementById('roomnum').readOnly = true
            console.log("You are joining room: " + data.id)
        }
        // Reset url for next person
        // Workaround
        socket.emit('reset url')
    });



    // Generate a random alphanumeric room id
    function randomroom() {
        document.getElementById('roomnum').value = Math.random().toString(36).substr(2, 12)
    }

    function getMainRoom() {
        document.getElementById('roomnum').value = "main"
    }

    $(document).ready(function() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get("room");
        if (roomId === undefined || roomId === "" || roomId == null)
            return;
        let userName = urlParams.get("username");
        if (userName === undefined || userName === "" || userName == null)
            userName = "random discord user!";


        const $roomArea = $('#roomArea');
        const $userFormArea = $('#userFormArea');
        const $roomnum = $('#roomnum');


        socket.emit('new user', userName, function(data) {
            if (data) {
                $userFormArea.hide();
                $roomArea.show();

                // Move footer to correct position
                document.getElementById('footer').style.position = 'relative';

                // No longer using initarea
                // var initStuff = document.getElementById("initArea")
                // initStuff.innerHTML = ""

                // This sets the room number on the client
                if ($roomnum.val() !== "") {
                    roomnum = $roomnum.val()
                }

                history.pushState('', 'Vynchronize', roomnum);
            }
        });
        // Join room
        socket.emit('new room', $roomnum.val(), function(data) {
            // This should only call back if the client is the host
            if (data) {
                console.log("Host is syncing the new socket!")
                syncVideo(roomnum)
            }
        });

    });


</script>

<!-- Bootstrap core JavaScript -->
<script src="js/dependencies/jquery.min.js"></script>
<script src="js/dependencies/bootstrap.bundle.min.js"></script>
<script src="js/dependencies/scrolling-nav.js"></script>
<script src="js/dependencies/bootstrap-notify.min.js"></script>
<!-- Plugin JavaScript -->
<script src="js/dependencies/jquery.easing.min.js"></script>


<!-- My JS files -->
<script src="js/sync.js"></script>
<script src="js/player.js"></script>
<script src="js/host.js"></script>
<script src="js/events.js"></script>
<script src="js/notify.js"></script>

<!-- Youtube -->
<script src="js/yt.js"></script>
<!-- HTML5 Player -->
<script src="js/html5.js"></script>

</body>

</html>

